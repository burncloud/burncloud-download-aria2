# BurnCloud Aria2 Download Manager - ä»£ç æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£ç›®å½•åŒ…å«äº† BurnCloud Aria2 Download Manager é¡¹ç›®çš„å®Œæ•´ä»£ç æ–‡æ¡£ã€‚è¯¥é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Rust çš„ aria2 ä¸‹è½½ç®¡ç†å™¨ï¼Œæä¾›äº†å®Œæ•´çš„ä¸‹è½½ç®¡ç†åŠŸèƒ½ã€‚

## æ–‡æ¡£ç»“æ„

```
docs/
â”œâ”€â”€ README.md                    # æœ¬æ–‡æ¡£ï¼ˆæ€»è§ˆï¼‰
â”œâ”€â”€ lib.md                       # åº“æ ¹æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ error.md                     # é”™è¯¯å¤„ç†æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ client/                      # å®¢æˆ·ç«¯æ¨¡å—æ–‡æ¡£
â”‚   â”œâ”€â”€ mod.md                   # å®¢æˆ·ç«¯ä¸»æ¨¡å—
â”‚   â””â”€â”€ types.md                 # å®¢æˆ·ç«¯ç±»å‹å®šä¹‰
â”œâ”€â”€ daemon/                      # å®ˆæŠ¤è¿›ç¨‹æ¨¡å—æ–‡æ¡£
â”‚   â”œâ”€â”€ mod.md                   # å®ˆæŠ¤è¿›ç¨‹ä¸»æ¨¡å—
â”‚   â”œâ”€â”€ platform.md             # å¹³å°ç›¸å…³åŠŸèƒ½
â”‚   â”œâ”€â”€ binary.md                # äºŒè¿›åˆ¶æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ process.md               # è¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ monitor.md               # å¥åº·ç›‘æ§
â”‚   â”œâ”€â”€ orchestrator.md          # ä¸»åè°ƒå™¨
â”‚   â””â”€â”€ README.md                # å®ˆæŠ¤è¿›ç¨‹æ¨¡å—æ€»è§ˆ
â”œâ”€â”€ manager/                     # ä¸‹è½½ç®¡ç†å™¨æ¨¡å—æ–‡æ¡£
â”‚   â”œâ”€â”€ mod.md                   # ç®¡ç†å™¨ä¸»æ¨¡å—
â”‚   â””â”€â”€ mapper.md                # çŠ¶æ€æ˜ å°„
â””â”€â”€ poller/                      # è½®è¯¢å™¨æ¨¡å—æ–‡æ¡£
    â”œâ”€â”€ mod.md                   # è½®è¯¢å™¨ä¸»æ¨¡å—
    â””â”€â”€ aggregator.md            # è¿›åº¦èšåˆå™¨
```

## æ ¸å¿ƒæ¨¡å—ä»‹ç»

### ğŸš€ [lib.rs](./lib.md) - åº“å…¥å£

- é¡¹ç›®çš„ä¸»å…¥å£ç‚¹
- å®šä¹‰æ¨¡å—ç»“æ„å’Œå…¬å…±æ¥å£
- æä¾›ç»Ÿä¸€çš„å¯¼å‡ºå’Œå¸¸é‡å®šä¹‰

### âŒ [error.rs](./error.md) - é”™è¯¯å¤„ç†

- ç»Ÿä¸€çš„é”™è¯¯ç±»å‹å®šä¹‰
- å®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
- ä¸å¤–éƒ¨åº“çš„é”™è¯¯è½¬æ¢

### ğŸŒ [client/](./client/) - Aria2 å®¢æˆ·ç«¯

- **[mod.rs](./client/mod.md)**: JSON-RPC å®¢æˆ·ç«¯å®ç°
- **[types.rs](./client/types.md)**: æ•°æ®ç±»å‹å®šä¹‰å’Œåºåˆ—åŒ–

**æ ¸å¿ƒåŠŸèƒ½**:
- JSON-RPC 2.0 é€šä¿¡åè®®
- æ”¯æŒæ‰€æœ‰ aria2 ä¸‹è½½ç±»å‹
- å®Œæ•´çš„ä»»åŠ¡æ§åˆ¶æ¥å£

### ğŸ”§ [daemon/](./daemon/) - å®ˆæŠ¤è¿›ç¨‹ç®¡ç†

- **[orchestrator.rs](./daemon/orchestrator.md)**: ä¸»åè°ƒå™¨
- **[process.rs](./daemon/process.md)**: è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **[monitor.rs](./daemon/monitor.md)**: å¥åº·ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
- **[binary.rs](./daemon/binary.md)**: äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½å’Œç®¡ç†
- **[platform.rs](./daemon/platform.md)**: è·¨å¹³å°å…¼å®¹æ€§

**æ ¸å¿ƒåŠŸèƒ½**:
- è‡ªåŠ¨ä¸‹è½½å’Œç®¡ç† aria2 äºŒè¿›åˆ¶æ–‡ä»¶
- è·¨å¹³å°è¿›ç¨‹ç®¡ç†
- å¥åº·ç›‘æ§å’Œæ•…éšœæ¢å¤
- ä¼˜é›…çš„å¯åŠ¨å’Œå…³é—­æµç¨‹

### ğŸ“¦ [manager/](./manager/) - ä¸‹è½½ç®¡ç†å™¨

- **[mod.rs](./manager/mod.md)**: ä¸»ä¸‹è½½ç®¡ç†å™¨å®ç°
- **[mapper.rs](./manager/mapper.md)**: çŠ¶æ€æ˜ å°„é€»è¾‘

**æ ¸å¿ƒåŠŸèƒ½**:
- å®ç°æ ‡å‡†çš„ DownloadManager trait
- æ”¯æŒå¤šç§ä¸‹è½½åè®®
- ä»»åŠ¡çŠ¶æ€ç®¡ç†å’Œè½¬æ¢
- è¿›åº¦ä¿¡æ¯è®¡ç®—

### ğŸ“Š [poller/](./poller/) - è¿›åº¦è½®è¯¢

- **[mod.rs](./poller/mod.md)**: åå°è½®è¯¢å™¨
- **[aggregator.rs](./poller/aggregator.md)**: å¤šæ–‡ä»¶è¿›åº¦èšåˆ

**æ ¸å¿ƒåŠŸèƒ½**:
- åå°ä»»åŠ¡è°ƒåº¦
- å¤šæ–‡ä»¶ä¸‹è½½è¿›åº¦èšåˆ
- ä¼˜é›…çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

## æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application   â”‚â”€â”€â”€â”€â”‚ DownloadManager â”‚â”€â”€â”€â”€â”‚   Aria2Client   â”‚
â”‚    (ç”¨æˆ·å±‚)      â”‚    â”‚   (ç®¡ç†å±‚)       â”‚    â”‚   (é€šä¿¡å±‚)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ ProgressPoller  â”‚    â”‚  Aria2Daemon    â”‚
                       â”‚   (ç›‘æ§å±‚)       â”‚    â”‚   (è¿›ç¨‹å±‚)       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚   aria2 è¿›ç¨‹    â”‚
                                               â”‚   (åº•å±‚æœåŠ¡)     â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚ â†’ DownloadManager â†’ TaskId æ˜ å°„ â†’ Aria2Client â†’ JSON-RPC â†’ aria2
              â†“                                                    â†‘
        è¿›åº¦æŸ¥è¯¢ â† ProgressPoller â† çŠ¶æ€æ˜ å°„ â† Aria2Status â†â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç‰¹æ€§å’Œä¼˜åŠ¿

### âœ¨ æ ¸å¿ƒç‰¹æ€§

1. **å®Œæ•´çš„ä¸‹è½½æ”¯æŒ**
   - HTTP/HTTPS/FTP
   - BitTorrent
   - Metalink/Meta4
   - ç£åŠ›é“¾æ¥

2. **æ™ºèƒ½è¿›ç¨‹ç®¡ç†**
   - è‡ªåŠ¨ä¸‹è½½ aria2 äºŒè¿›åˆ¶æ–‡ä»¶
   - å¥åº·ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
   - ä¼˜é›…å¯åŠ¨å’Œå…³é—­

3. **è·¨å¹³å°å…¼å®¹**
   - Windowsã€Linuxã€macOS æ”¯æŒ
   - å¹³å°ç‰¹å®šçš„è·¯å¾„å’Œæƒé™å¤„ç†

4. **å¼‚æ­¥æ¶æ„**
   - åŸºäº tokio å¼‚æ­¥è¿è¡Œæ—¶
   - éé˜»å¡æ“ä½œ
   - é«˜å¹¶å‘æ”¯æŒ

5. **å¼ºç±»å‹å®‰å…¨**
   - Rust ç±»å‹ç³»ç»Ÿ
   - ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
   - å†…å­˜å®‰å…¨ä¿è¯

### ğŸ¯ è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªæ¨¡å—ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½
2. **è´£ä»»åˆ†ç¦»**: æ¸…æ™°çš„æ¥å£å’ŒèŒè´£åˆ’åˆ†
3. **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œä¼ æ’­
4. **èµ„æºç®¡ç†**: è‡ªåŠ¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
5. **æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œåè®®

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```rust
use burncloud_download_aria2::{Aria2DownloadManager, DaemonConfig};
use std::path::PathBuf;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // åˆ›å»ºä¸‹è½½ç®¡ç†å™¨
    let manager = Aria2DownloadManager::new(
        "http://localhost:6800/jsonrpc".to_string(),
        Some("secret".to_string())
    ).await?;

    // æ·»åŠ ä¸‹è½½ä»»åŠ¡
    let task_id = manager.add_download(
        "http://example.com/file.zip".to_string(),
        PathBuf::from("/downloads/file.zip")
    ).await?;

    // ç›‘æ§è¿›åº¦
    loop {
        let progress = manager.get_progress(task_id).await?;
        println!("è¿›åº¦: {}/{} bytes ({}%)",
            progress.downloaded_bytes,
            progress.total_bytes.unwrap_or(0),
            if let Some(total) = progress.total_bytes {
                (progress.downloaded_bytes * 100 / total)
            } else { 0 }
        );

        let task = manager.get_task(task_id).await?;
        if matches!(task.status, DownloadStatus::Completed) {
            println!("ä¸‹è½½å®Œæˆï¼");
            break;
        }

        tokio::time::sleep(std::time::Duration::from_secs(1)).await;
    }

    Ok(())
}
```

### é«˜çº§é…ç½®

```rust
use burncloud_download_aria2::{Aria2Daemon, DaemonConfig};
use std::time::Duration;

// è‡ªå®šä¹‰å®ˆæŠ¤è¿›ç¨‹é…ç½®
let config = DaemonConfig {
    rpc_port: 6801,
    rpc_secret: "my_custom_secret".to_string(),
    download_dir: PathBuf::from("/custom/downloads"),
    max_restart_attempts: 5,
    health_check_interval: Duration::from_secs(5),
    ..Default::default()
};

// ç›´æ¥å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹
let client = Arc::new(Aria2Client::new(
    format!("http://localhost:{}/jsonrpc", config.rpc_port),
    Some(config.rpc_secret.clone())
));

let daemon = Aria2Daemon::start(config, client).await?;
```

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä¸‹è½½åè®®

1. åœ¨ `DownloadType` æšä¸¾ä¸­æ·»åŠ æ–°ç±»å‹
2. åœ¨ `detect_download_type` ä¸­æ·»åŠ æ£€æµ‹é€»è¾‘
3. åœ¨ `add_download` ä¸­æ·»åŠ å¤„ç†åˆ†æ”¯
4. å¯èƒ½éœ€è¦æ‰©å±• aria2 å®¢æˆ·ç«¯æ–¹æ³•

### æ‰©å±•çŠ¶æ€æ˜ å°„

1. åœ¨ `mapper.rs` ä¸­æ·»åŠ æ–°çš„çŠ¶æ€æ˜ å°„è§„åˆ™
2. æ›´æ–° `DownloadStatus` æšä¸¾ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

### å¹³å°æ”¯æŒ

1. åœ¨ `platform.rs` ä¸­æ·»åŠ å¹³å°ç‰¹å®šä»£ç 
2. ä½¿ç”¨æ¡ä»¶ç¼–è¯‘æ ‡è®° `#[cfg(...)]`
3. æ›´æ–°äºŒè¿›åˆ¶ä¸‹è½½ URL å’Œè·¯å¾„é€»è¾‘

## æµ‹è¯•å’Œè°ƒè¯•

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
cargo test client::
cargo test daemon::
cargo test manager::
```

### è°ƒè¯•æ¨¡å¼

é¡¹ç›®åœ¨ debug æ¨¡å¼ä¸‹æä¾›é¢å¤–çš„è¯Šæ–­ä¿¡æ¯ï¼š

- aria2 è¿›ç¨‹å¯åŠ¨å‚æ•°
- é”™è¯¯è¯¦ç»†ä¿¡æ¯
- ç½‘ç»œè¯·æ±‚æ—¥å¿—

### æ—¥å¿—è¾“å‡º

ä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—çº§åˆ«ï¼š

```bash
RUST_LOG=debug cargo run
```

## ä¾èµ–è¯´æ˜

### æ ¸å¿ƒä¾èµ–

- **tokio**: å¼‚æ­¥è¿è¡Œæ—¶
- **reqwest**: HTTP å®¢æˆ·ç«¯
- **serde**: åºåˆ—åŒ–æ¡†æ¶
- **anyhow**: é”™è¯¯å¤„ç†
- **uuid**: å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆ

### å¹³å°ä¾èµ–

- **dirs**: ç›®å½•è·¯å¾„è·å–
- **zip**: å‹ç¼©æ–‡ä»¶å¤„ç†
- **base64**: Base64 ç¼–ç 

## æ€§èƒ½è€ƒè™‘

### å†…å­˜ä½¿ç”¨

- ä½¿ç”¨ `Arc` å…±äº«æ•°æ®ï¼Œå‡å°‘å¤åˆ¶
- æµå¼å¤„ç†å¤§æ–‡ä»¶ä¸‹è½½
- åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„çŠ¶æ€

### ç½‘ç»œæ•ˆç‡

- è¿æ¥å¤ç”¨
- æ‰¹é‡çŠ¶æ€æŸ¥è¯¢
- æ™ºèƒ½è½®è¯¢é—´éš”

### å¹¶å‘æ€§èƒ½

- å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
- æ”¯æŒå¤šä»»åŠ¡å¹¶å‘ä¸‹è½½
- çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **aria2 å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - éªŒè¯ä¸‹è½½ç›®å½•æƒé™
   - æŸ¥çœ‹ debug æ¨¡å¼è¾“å‡º

2. **RPC è¿æ¥å¤±è´¥**
   - ç¡®è®¤ aria2 è¿›ç¨‹è¿è¡ŒçŠ¶æ€
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   - éªŒè¯ RPC å¯†é’¥é…ç½®

3. **ä¸‹è½½ä»»åŠ¡ä¸å“åº”**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ URL æœ‰æ•ˆæ€§
   - æŸ¥çœ‹ aria2 é”™è¯¯æ—¥å¿—

### è°ƒè¯•æŠ€å·§

1. ä½¿ç”¨ debug ç¼–è¯‘è·å–è¯¦ç»†æ—¥å¿—
2. æ£€æŸ¥ aria2 ä¼šè¯æ–‡ä»¶å†…å®¹
3. ä½¿ç”¨ç½‘ç»œæŠ“åŒ…åˆ†æ RPC é€šä¿¡
4. ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## è´¡çŒ®æŒ‡å—

### ä»£ç é£æ ¼

- éµå¾ª Rust å®˜æ–¹æ ¼å¼è§„èŒƒ
- ä½¿ç”¨ `cargo fmt` æ ¼å¼åŒ–ä»£ç 
- é€šè¿‡ `cargo clippy` æ£€æŸ¥

### æ–‡æ¡£è¦æ±‚

- ä¸ºå…¬å…± API æ·»åŠ æ–‡æ¡£æ³¨é‡Š
- æ›´æ–°ç›¸å…³çš„ markdown æ–‡æ¡£
- åŒ…å«ä½¿ç”¨ç¤ºä¾‹

### æµ‹è¯•è¦æ±‚

- ä¸ºæ–°åŠŸèƒ½æ·»åŠ å•å…ƒæµ‹è¯•
- ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æ·»åŠ é›†æˆæµ‹è¯•ï¼ˆå¦‚é€‚ç”¨ï¼‰

---

## æ€»ç»“

BurnCloud Aria2 Download Manager æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€è®¾è®¡è‰¯å¥½çš„ä¸‹è½½ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æ¨¡å—åŒ–çš„æ¶æ„ã€å¼ºç±»å‹çš„è®¾è®¡å’Œå®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œå®ƒæä¾›äº†å¯é ã€é«˜æ•ˆçš„ä¸‹è½½ç®¡ç†æœåŠ¡ã€‚

æœ¬æ–‡æ¡£é›†åˆä¸ºå¼€å‘è€…æä¾›äº†å®Œæ•´çš„ä»£ç ç†è§£å’Œä½¿ç”¨æŒ‡å—ï¼Œæœ‰åŠ©äºé¡¹ç›®çš„ç»´æŠ¤ã€æ‰©å±•å’Œé›†æˆã€‚